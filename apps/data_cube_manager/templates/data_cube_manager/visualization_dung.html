{% extends "default.html" %} {% load bootstrap3 %}
<!--
    Copyright 2016 United States Government as represented by the Administrator
    of the National Aeronautics and Space Administration. All Rights Reserved.

    Portion of this code is Copyright Geoscience Australia, Licensed under the
    Apache License, Version 2.0 (the "License"); you may not use this file
    except in compliance with the License. You may obtain a copy of the License
    at

    http://www.apache.org/licenses/LICENSE-2.0

    The CEOS 2 platform is licensed under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0.

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
    License for the specific language governing permissions and limitations
    under the License.
  -->
{% block css %}
<link rel="stylesheet" href="/static/assets/css/map_tool.css" />
<link rel="stylesheet" href="/static/assets/css/data_cube_manager.css" />
<link href="/static/assets/js/leaflet/leaflet.css" rel="stylesheet" type="text/css" />
<link href="/static/assets/js/Leaflet.draw/leaflet.draw.css" rel="stylesheet" type="text/css" />
<style>
  #areaList {
    display: flex;
    flex-direction: column;
  }

  .item {
    display: flex;
  }
</style>
{% endblock %}

{% block javascript %}
<script src="/static/assets/js/leaflet/leaflet.js"></script>
<script src="/static/assets/js/Leaflet.draw/leaflet.draw.js"></script>
<script src="/static/assets/js/drawmap_leaflet.js"></script>

<script>

  var map;
  var data;

  $(() => {
    $('.datepicker').datepicker({
        changeMonth: true,
        changeYear: true,
        showButtonPanel: true,
        yearRange: "-30:+0"
    });
    $(".tooltipped").tooltip();

    // Map related functionality - generate two leaflet maps, one for the modal and one for the main view.
    osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
    });
    info_osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      noWrap: true,
      attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
    });

    map = new L.Map('map', {
      minZoom: 3,
      maxZoom: 15,
      zoomSnap: 0.25,
    });


    map.addLayer(osm);
    map.setView([0, 0], 3);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    var drawControl = new L.Control.Draw({
      draw: {
        marker: false,
        polyline: false,
        circle: false
      },
      edit: {
        featureGroup: drawnItems
      }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, (e) => {
      drawnItems.clearLayers()
      var type = e.layerType,
          layer = e.layer;
      if (type === 'marker') {
          // Do marker specific actions
      }
      // Do whatever else you need to. (save to db; add to map etc)
      drawnItems.addLayer(layer.setStyle({fillOpacity: 0, color: 'red'}));
    });

    map.on('draw:deleted', function (e) {
      drawnItems.clearLayers()
    });

    var ingestedData = new L.FeatureGroup();
    ingestedData.addTo(map)

    window.search = () => {
      let startDate = jQuery('#id_start_date').val() ? jQuery('#id_start_date').val() : jQuery('#id_start_date').attr('placeholder')
      let endDate = jQuery('#id_end_date').val() ? jQuery('#id_end_date').val() : jQuery('#id_end_date').attr('placeholder')
      let product = jQuery('#id_platform').val()
      let area = drawnItems.toGeoJSON()

      jQuery.ajax({
        method: 'POST',
        url: '{% url "get_ingested_areas" %}',
        data: JSON.stringify({
          startDate,
          endDate,
          product,
          area
        }),
        contentType: "application/json; charset=utf-8",
        success: (result) => {
          data = result
          ingestedData.clearLayers()
          let ingested = L.geoJSON(data)
          ingestedData.addLayer(ingested)
          fillData()
        }
      })
    }

    window.fillData = () => {
      jQuery('#areaList').html('')
      let html = ''
      let arr = data.features
      for (let i = 0; i < arr.length; i++) {
        html += `<div onclick="dataClick(${i})" style="cursor: pointer;">
              <div class="item">
                <div style="flex: 1">
                  <div>
                    <span style="font-weight: bold;">ID: </span>${arr[i].properties.cube_id}
                  </div>
                  <div>
                    <span style="font-weight: bold;">Acquired date: </span>${arr[i].properties.acquired.substring(0, 10)}
                  </div>
                </div>
                <div>
                  <button type="button" class="btn btn-default" aria-label="Left Align">
                    <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                  </button>
                </div>
              </div>
              <hr>
            </div>`
      }
      jQuery('#areaList').html(html)
    }

    window.dataClick = (i) => {
      var geojsonLayer = L.geoJson(data.features[i]);
      map.fitBounds(geojsonLayer.getBounds());
    }
  });

</script>
{% endblock %}

{% block content %}
<div class="container-fluid no_footer">
    <div class="row fullscreen-row">
      <div class="col-lg-3 fullscreen-col seamless-col">
        <div class="col-lg-12">
          <h1 class="page-header">Ingested Data Cubes</h1>
          <form>
            {% bootstrap_form form %}
          </form>
          <button class="btn btn-primary" onclick="search()">Search</button>
          <hr>
          <div id="areaList">
            
            
          </div>
        </div>
      </div>
      <div class="col-lg-9 fullscreen-col seamless-col map-col">
        <div id="map-canvas" class="map">
          <div id="map" class="map">
          </div>
        </div>
      </div>
    </div>
</div>
{% endblock %}
